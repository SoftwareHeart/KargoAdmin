@model Blog
@using System.Text.RegularExpressions
@using KargoAdmin.Services
@using KargoAdmin.Helpers
@inject ILanguageService LanguageService
@{
    ViewData["Title"] = Model != null ? Model.GetLocalizedTitle(LanguageService) : "Sayfa Bulunamadı";
    Layout = "_PublicLayout";
}

<!-- Modern Blog Detail Header -->
<section class="blog-detail-hero">
    <div class="blog-hero-background" style="background-image: url('@(!string.IsNullOrEmpty(Model?.ImageUrl) ? "/uploads/" + Model.ImageUrl : "/img/blog-no-image.png")')"></div>
    <div class="blog-hero-overlay"></div>
    <div class="container">
        <div class="blog-hero-content">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="blog-breadcrumb-nav">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Aleris")">@(LanguageService.GetCurrentLanguage() == "en" ? "Home" : "Ana Sayfa")</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "UsefulInfo")">@(LanguageService.GetCurrentLanguage() == "en" ? "Useful Information" : "Faydalı Bilgiler")</a></li>
                    <li class="breadcrumb-item active">@(Model != null ? Model.GetLocalizedTitle(LanguageService) : "Bilinmeyen")</li>
                </ol>
            </nav>

            <!-- Blog Meta -->
            <div class="blog-hero-meta">
                <div class="meta-item">
                    <i class="far fa-calendar-alt"></i>
                    <span>@(Model?.PublishDate.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo(LanguageService.GetCurrentLanguage() == "en" ? "en-US" : "tr-TR")) ?? "Tarih Bilinmiyor")</span>
                </div>
                <div class="meta-item">
                    <i class="far fa-eye"></i>
                    <span>@(Model?.ViewCount ?? 0) @(LanguageService.GetCurrentLanguage() == "en" ? "views" : "görüntülenme")</span>
                </div>
                @{
                    var wordCount = 0;
                    var readingTime = 1;
                    if (!string.IsNullOrEmpty(Model?.Content))
                    {
                        wordCount = Regex.Replace(Model.Content, "<.*?>", string.Empty).Split(new char[] { ' ', '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).Length;
                        var wordsPerMinute = 250;
                        readingTime = (int)Math.Ceiling((double)wordCount / wordsPerMinute);
                        if (readingTime == 0) readingTime = 1;
                    }
                }
                <div class="meta-item">
                    <i class="far fa-clock"></i>
                    <span>@readingTime dk okuma</span>
                </div>
            </div>

            <!-- Blog Title -->
            <h1 class="blog-hero-title">@(Model != null ? Model.GetLocalizedTitle(LanguageService) : "Başlık Bulunamadı")</h1>

            <!-- Author Info -->
            @if (!string.IsNullOrEmpty(Model?.Author?.FirstName))
            {
                <div class="blog-hero-author">
                    <div class="author-avatar">
                        <img src="/img/author-placeholder.jpg" alt="@Model.Author.FirstName @Model.Author.LastName">
                    </div>
                    <div class="author-info">
                        <span class="author-name">@Model.Author.FirstName @(Model.Author.LastName ?? "")</span>
                         <span class="author-title">@(LanguageService.GetCurrentLanguage() == "en" ? "Content Editor" : "İçerik Editörü")</span>
                    </div>
                </div>
            }
        </div>
    </div>
</section>

<!-- Blog Content Section -->
<section class="blog-detail-content">
    <div class="container">
        <!-- Main Content - Full Width -->
        <div class="row justify-content-center">
            <div class="col-lg-12 col-xl-12">
                <!-- Blog Content Card -->
                <article class="blog-content-card">
                    <!-- Content -->
                    <div class="blog-article-content">
                        @Html.Raw(Model != null ? Model.GetLocalizedContent(LanguageService) : "İçerik bulunamadı.")
                    </div>

                    <!-- Tags Section -->
                    @if (Model != null && !string.IsNullOrEmpty(Model.GetLocalizedTags(LanguageService)))
                    {
                        <div class="blog-tags-section">
                            <h4 class="tags-title">
                                <i class="fas fa-tags"></i>
                                @(LanguageService.GetCurrentLanguage() == "en" ? "Tags" : "Etiketler")
                            </h4>
                            <div class="tags-container">
                                @foreach (var tag in Model.GetLocalizedTags(LanguageService).Split(',', StringSplitOptions.RemoveEmptyEntries))
                                {
                                    <a href="@Url.Action("Tag", "UsefulInfo", new { tag = tag.Trim() })"
                                       class="blog-detail-tag">
                                        #@tag.Trim()
                                    </a>
                                }
                            </div>
                        </div>
                    }

                    <!-- Social Share -->
                    <div class="blog-share-section">
                        <h4 class="share-title">
                            <i class="fas fa-share-alt"></i>
                            @(LanguageService.GetCurrentLanguage() == "en" ? "Share this information" : "Bu faydalı bilgiyi paylaş")
                        </h4>
                        <div class="share-buttons">
                            <a href="javascript:void(0)"
                               onclick="shareOnFacebook(); return false;"
                               class="share-btn facebook">
                                <i class="fab fa-facebook-f"></i>
                                <span>Facebook</span>
                            </a>
                            <a href="javascript:void(0)"
                               onclick="shareOnTwitter('@Html.Raw(Html.Encode(Model?.Title ?? ""))'); return false;"
                               class="share-btn twitter">
                                <i class="fab fa-twitter"></i>
                                <span>Twitter</span>
                            </a>
                            <a href="javascript:void(0)"
                               onclick="shareOnLinkedIn('@Html.Raw(Html.Encode(Model?.Title ?? ""))'); return false;"
                               class="share-btn linkedin">
                                <i class="fab fa-linkedin-in"></i>
                                <span>LinkedIn</span>
                            </a>
                            <a href="javascript:void(0)"
                               onclick="copyToClipboard(this); return false;"
                               class="share-btn copy">
                                <i class="fas fa-link"></i>
                                <span>@(LanguageService.GetCurrentLanguage() == "en" ? "Copy Link" : "Linki Kopyala")</span>
                            </a>
                        </div>
                    </div>
                </article>

                <!-- Navigation -->
                <div class="blog-navigation">
                    <a href="@Url.Action("Index", "UsefulInfo")" class="nav-btn back-to-list">
                        <i class="fas fa-arrow-left"></i>
                        <span>@(LanguageService.GetCurrentLanguage() == "en" ? "Back to All" : "Tüm Faydalı Bilgilere Dön")</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Modern Related Posts Section -->
        @if (ViewBag.RelatedInfos != null && ((List<Blog>)ViewBag.RelatedInfos).Any())
        {
            <div class="row mt-5">
                <div class="col-12">
                    <div class="modern-related-section">
                        <!-- Dinamik Başlık -->
                        <div class="section-header">
                            @{
                                string sectionTitle = LanguageService.GetCurrentLanguage() == "en" ? "Related Useful Information" : "İlgili Faydalı Bilgiler";
                                string sectionIcon = "fas fa-lightbulb";
                                string sectionDescription = LanguageService.GetCurrentLanguage() == "en" ? "Other helpful information on this topic" : "Bu konuyla ilgili diğer faydalı bilgiler";
                            }

                            <div class="section-title-wrapper">
                                <h2 class="section-title">
                                    <i class="@sectionIcon"></i>
                                    @sectionTitle
                                </h2>
                                <p class="section-subtitle">@sectionDescription</p>
                            </div>
                        </div>

                        <!-- Modern Cards Grid -->
                        <div class="modern-posts-grid">
                            @foreach (var relatedInfo in ((List<Blog>)ViewBag.RelatedInfos))
                            {
                                <article class="modern-post-card">
                                    <!-- Card Image -->
                                    <div class="card-image-wrapper">
                                        <img src="@(!string.IsNullOrEmpty(relatedInfo.ImageUrl) ? "/uploads/" + relatedInfo.ImageUrl : "/img/blog-no-image.png")"
                                             alt="@relatedInfo.Title"
                                             class="card-image">

                                        <!-- Overlay with Action -->
                                        <div class="image-overlay">
                                            <a href="@Url.Action("Details", "UsefulInfo", new { id = relatedInfo.Id, slug = relatedInfo.Slug })"
                                               class="read-action-btn">
                                                <i class="fas fa-arrow-right"></i>
                                            </a>
                                        </div>

                                        <!-- Category Badge -->
                                        @if (!string.IsNullOrEmpty(relatedInfo.GetLocalizedTags(LanguageService)))
                                        {
                                            <span class="category-badge">
                                                @relatedInfo.GetLocalizedTags(LanguageService).Split(',').FirstOrDefault()?.Trim()
                                            </span>
                                        }
                                    </div>

                                    <!-- Card Content -->
                                    <div class="card-content">
                                        <!-- Meta Info -->
                                        <div class="post-meta">
                                            <span class="meta-item">
                                                <i class="far fa-calendar-alt"></i>
                                                @relatedInfo.PublishDate.ToString("dd MMM yyyy", new System.Globalization.CultureInfo(LanguageService.GetCurrentLanguage() == "en" ? "en-US" : "tr-TR"))
                                            </span>
                                            <span class="meta-item">
                                                <i class="far fa-eye"></i>
                                                @relatedInfo.ViewCount
                                            </span>
                                        </div>

                                        <!-- Title -->
                                        <h3 class="post-title">
                                            <a href="@Url.Action("Details", "UsefulInfo", new { id = relatedInfo.Id, slug = relatedInfo.Slug })">
                                                @relatedInfo.GetLocalizedTitle(LanguageService)
                                            </a>
                                        </h3>

                                        <!-- Excerpt -->
                                        @{
                                            var localizedContent = relatedInfo.GetLocalizedContent(LanguageService) ?? "";
                                            var plainText = Regex.Replace(localizedContent, "<.*?>", string.Empty);
                                            var excerpt = plainText.Length > 100 ? plainText.Substring(0, 100) + "..." : plainText;
                                        }
                                        <p class="post-excerpt">@excerpt</p>

                                        <!-- Read More -->
                                        <div class="read-more-wrapper">
                                            <a href="@Url.Action("Details", "UsefulInfo", new { id = relatedInfo.Id, slug = relatedInfo.Slug })"
                                               class="read-more-link">
                                                @(LanguageService.GetCurrentLanguage() == "en" ? "Read More" : "Devamını Oku")
                                                <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </div>
                                    </div>
                                </article>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</section>

@section Styles {
    <link href="~/css/blog-detail.css" rel="stylesheet" />
}

<script>
    // Social Share Functions - Dinamik URL kullanımı
    function getCurrentPageUrl() {
        return window.location.href;
    }

    function getCurrentPageTitle() {
        return document.title;
    }

    function shareOnFacebook() {
        const url = getCurrentPageUrl();
        window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(url), '_blank', 'width=600,height=400');
    }

    function shareOnTwitter(title) {
        const url = getCurrentPageUrl();
        const text = title || getCurrentPageTitle();
        window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(text) + '&url=' + encodeURIComponent(url), '_blank', 'width=600,height=400');
    }

    function shareOnLinkedIn(title) {
        const url = getCurrentPageUrl();
        window.open('https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(url), '_blank', 'width=600,height=400');
    }

    function copyToClipboard(buttonElement) {
        const url = getCurrentPageUrl();

        navigator.clipboard.writeText(url).then(function() {
            // Show success message
            const btn = buttonElement;
            const originalText = btn.querySelector('span').textContent;
            const originalBg = btn.style.background;

            btn.querySelector('span').textContent = 'Kopyalandı!';
            btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

            setTimeout(() => {
                btn.querySelector('span').textContent = originalText;
                btn.style.background = originalBg;
            }, 2000);
        }).catch(function(err) {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = url;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                const btn = buttonElement;
                const originalText = btn.querySelector('span').textContent;
                const originalBg = btn.style.background;

                btn.querySelector('span').textContent = 'Kopyalandı!';
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

                setTimeout(() => {
                    btn.querySelector('span').textContent = originalText;
                    btn.style.background = originalBg;
                }, 2000);
            } catch (err) {
                console.error('Kopyalama başarısız:', err);
                alert('Link kopyalanamadı. Lütfen manuel olarak kopyalayın: ' + url);
            }

            document.body.removeChild(textArea);
        });
    }

    // Smooth scroll for internal links
    document.addEventListener('DOMContentLoaded', function() {
        // Internal link scroll
        const links = document.querySelectorAll('a[href^="#"]');
        links.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Reading progress bar (optional)
        const article = document.querySelector('.blog-article-content');
        if (article) {
            const progressBar = document.createElement('div');
            progressBar.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 0%;
                height: 3px;
                background: linear-gradient(90deg, #005cb9, #0066cc);
                z-index: 9999;
                transition: width 0.1s ease;
            `;
            document.body.appendChild(progressBar);

            window.addEventListener('scroll', function() {
                const scrolled = window.pageYOffset;
                const articleTop = article.offsetTop;
                const articleHeight = article.offsetHeight;
                const windowHeight = window.innerHeight;
                const maxScroll = articleTop + articleHeight - windowHeight;

                if (scrolled >= articleTop && scrolled <= maxScroll) {
                    const progress = ((scrolled - articleTop) / (articleHeight - windowHeight)) * 100;
                    progressBar.style.width = Math.min(100, Math.max(0, progress)) + '%';
                } else if (scrolled < articleTop) {
                    progressBar.style.width = '0%';
                } else {
                    progressBar.style.width = '100%';
                }
            });
        }
    });
</script>